<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - MenuFinder</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #1a1a1a; color: white; padding: 40px; }
        .admin-card { background: #2d2d2d; max-width: 600px; margin: 0 auto; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h1 { color: #ff385c; text-align: center; margin-bottom: 30px; }
        
        label { display: block; margin-top: 15px; font-size: 0.9rem; color: #ccc; }
        input, select, textarea { width: 100%; padding: 12px; background: #404040; border: 1px solid #555; color: white; border-radius: 8px; margin-top: 5px; font-family: inherit; font-size: 1rem; }
        input:focus, textarea:focus { outline: 2px solid #ff385c; border-color: transparent; }
        
        /* Estilos para el Autocomplete de Direcciones */
        .address-wrapper { position: relative; }
        .suggestions-list {
            position: absolute;
            top: 100%; left: 0; right: 0;
            background: #fff;
            color: #333;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            display: none; /* Oculto por defecto */
        }
        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        .suggestion-item:hover { background-color: #f0f0f0; }
        .suggestion-item strong { color: #ff385c; }

        button { width: 100%; background: #ff385c; color: white; border: none; padding: 15px; font-weight: bold; margin-top: 25px; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        button:hover { background: #e03e58; transform: translateY(-2px); }
        
        .row { display: flex; gap: 15px; }
        .col { flex: 1; }
    </style>
</head>
<body>

    <div class="admin-card">
        <h1>üîê A√±adir Restaurante</h1>
        <form id="form-admin">
            <label>Nombre del Restaurante</label>
            <input type="text" id="nombre" required placeholder="Ej: La Casa del Sabor">

            <div class="row">
                <div class="col">
                    <label>Tipo de Cocina</label>
                    <input list="lista-cocinas" id="cocina" placeholder="Escribe o selecciona..." required>
                    <datalist id="lista-cocinas">
                        <option value="Americana"><option value="Asi√°tica"><option value="Espa√±ola">
                        <option value="Italiana"><option value="Japonesa"><option value="Mexicana">
                        <option value="Vegana"><option value="Vegetariana"><option value="Fusi√≥n">
                    </datalist>
                </div>
                <div class="col">
                    <label>Precio</label>
                    <select id="precio">
                        <option>‚Ç¨</option>
                        <option>‚Ç¨‚Ç¨</option>
                        <option>‚Ç¨‚Ç¨‚Ç¨</option>
                        <option>‚Ç¨‚Ç¨‚Ç¨‚Ç¨</option>
                    </select>
                </div>
            </div>

            <label>Direcci√≥n (Busca tu calle en Espa√±a)</label>
            <div class="address-wrapper">
                <input type="text" id="direccion-input" placeholder="Empieza a escribir... (Ej: Gran V√≠a, Madrid)" autocomplete="off">
                <div id="sugerencias" class="suggestions-list"></div>
            </div>
            
            <input type="hidden" id="lat">
            <input type="hidden" id="lng">
            <input type="hidden" id="direccion-final">

            <label>Al√©rgenos (Separados por coma)</label>
            <input type="text" id="alergenos" placeholder="Ej: Gluten, Lactosa, Soja">

            <label>Descripci√≥n</label>
            <textarea id="descripcion" rows="3" placeholder="Breve descripci√≥n del local..."></textarea>

            <button type="submit">GUARDAR RESTAURANTE üíæ</button>
        </form>
    </div>

    <script>
        // --- L√ìGICA DE AUTOCOMPLETADO ---
        const inputDireccion = document.getElementById('direccion-input');
        const listaSugerencias = document.getElementById('sugerencias');
        let timeoutId; // Para no buscar en cada letra, sino al dejar de escribir

        inputDireccion.addEventListener('input', () => {
            clearTimeout(timeoutId);
            const texto = inputDireccion.value;
            
            if (texto.length < 3) {
                listaSugerencias.style.display = 'none';
                return;
            }

            // Esperar 300ms antes de buscar (para no saturar la API)
            timeoutId = setTimeout(async () => {
                // Buscamos solo en Espa√±a (countrycodes=es)
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(texto)}&countrycodes=es&addressdetails=1&limit=5`;
                
                try {
                    const res = await fetch(url);
                    const datos = await res.json();
                    mostrarSugerencias(datos);
                } catch (error) {
                    console.error("Error buscando direcci√≥n", error);
                }
            }, 300);
        });

        function mostrarSugerencias(lugares) {
            listaSugerencias.innerHTML = '';
            if (lugares.length === 0) {
                listaSugerencias.style.display = 'none';
                return;
            }

            lugares.forEach(lugar => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                // Mostramos Calle + Ciudad para que quede claro
                const textoVisual = lugar.display_name; 
                div.innerText = textoVisual;

                div.onclick = () => seleccionarDireccion(lugar);
                listaSugerencias.appendChild(div);
            });

            listaSugerencias.style.display = 'block';
        }

        function seleccionarDireccion(lugar) {
            // Rellenamos los campos visibles y ocultos
            inputDireccion.value = lugar.display_name; // Poner nombre completo
            document.getElementById('direccion-final').value = lugar.display_name;
            document.getElementById('lat').value = lugar.lat;
            document.getElementById('lng').value = lugar.lon;
            
            // Ocultar lista
            listaSugerencias.style.display = 'none';
            
            // Feedback visual
            inputDireccion.style.borderColor = '#4ade80'; // Borde verde
        }

        // Cerrar lista si hago clic fuera
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.address-wrapper')) {
                listaSugerencias.style.display = 'none';
            }
        });

        // --- GUARDAR RESTAURANTE ---
        document.getElementById('form-admin').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validaci√≥n: obligar a elegir una direcci√≥n de la lista
            const lat = document.getElementById('lat').value;
            if (!lat) {
                alert("‚ö†Ô∏è Por favor, selecciona una direcci√≥n v√°lida de la lista desplegable.");
                return;
            }

            const nuevoRestaurante = {
                nombre: document.getElementById('nombre').value,
                cocina: document.getElementById('cocina').value,
                direccion: document.getElementById('direccion-final').value,
                precio: document.getElementById('precio').value.split(' ')[0],
                alergenos: document.getElementById('alergenos').value.split(',').map(s => s.trim()).filter(Boolean),
                descripcion: document.getElementById('descripcion').value,
                // Usamos las coordenadas exactas que nos dio el autocompletado
                coords: { 
                    lat: parseFloat(document.getElementById('lat').value), 
                    lng: parseFloat(document.getElementById('lng').value) 
                },
                puntuacion: 5.0,
                resenas: 0,
                menu: { entrantes: [], principales: [], postres: [] }
            };

            const res = await fetch('/api/admin/restaurantes', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(nuevoRestaurante)
            });

            if(res.ok) {
                alert('‚úÖ ¬°Restaurante publicado con ubicaci√≥n exacta!');
                e.target.reset();
                document.getElementById('lat').value = ''; // Limpiar coords
                inputDireccion.style.borderColor = '#555'; // Reset borde
            } else {
                alert('Error al guardar');
            }
        });
    </script>
</body>
</html>